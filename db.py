import os
import psycopg2
from dotenv import load_dotenv

class DB:
    def __init__(self, host='localhost', port=5432, database='postgres', user='postgres', password='postgres', credentials=None):
        self.conn = None
        self.credentials = credentials
        self.host = host
        self.port = port
        self.database = database
        self.user = user
        self.password = password

    def connect(self):
        if self.credentials is not None:
            self.conn = psycopg2.connect(self.credentials, sslmode='require')
        else:
            self.conn = psycopg2.connect(
                host=self.host,
                port=self.port,
                database=self.database,
                user=self.user,
                password=self.password,
                sslmode='require')

    def disconnect(self):
        if self.conn is not None:
            self.conn.close()
            self.conn = None

    def __create_server_table(self):
        if self.conn is None:
            self.connect()
        cur = self.conn.cursor()
        cur.execute('''CREATE TABLE SERVER
        (ID BIGINT PRIMARY KEY     NOT NULL,
        VALUE           JSON    NOT NULL);''')
        self.conn.commit()
        print('SERVER TABLE CREATED')

    def update_server(self, id, value):
        if self.conn is None:
            self.connect()
        cur = self.conn.cursor()
        cur.execute('''INSERT INTO SERVER (id, value)
        VALUES ({}, '{}') ON CONFLICT (id)
        DO
         UPDATE
         SET value = EXCLUDED.value;
        '''.format(id, value))
        self.conn.commit()

    def get_server(self, id):
        if self.conn is None:
            self.connect()
        cur = self.conn.cursor()
        try:
            cur.execute(f'SELECT * FROM SERVER WHERE id = {str(id)}')
        except psycopg2.errors.UndefinedTable:
            print('NO TABLE')
            self.conn.reset()
            self.__create_server_table()
            cur = self.conn.cursor()
            cur.execute(f'SELECT * FROM SERVER WHERE id = {str(id)}')
        rows = cur.fetchall()
        if len(rows) < 1:
            return None
        return rows[0][1]

load_dotenv()
import json
#db = DB(host=os.getenv('DB_URL'), port=5432, database=os.getenv('DB_NAME'), user=os.getenv('DB_USER'), password=os.getenv('DB_PWD'))
db = DB(credentials=os.getenv('DATABASE_URL'))

#srv = {"id": 361669162818600961, "name": "Discord Des Familleshihiger", "lang": "fr", "bot_text_channel_name": "bot", "log_text_channel_name": "logs", "cmd_prefix": "!!", "admin_logs": True, "group_perks": {"361673291473354752": ["group.moderator", "cmd.tft"]}, "use_accept": "Member", "accept_rank": "Member", "members": [{"id": 293865497634537474, "name": "Scotty", "display_name": "Scotty", "discriminator": "5529", "afk_mentions": True, "xp": 11, "last_login": "Tue Nov 19 03:08:59 2019", "last_daily_reward": "Tue Nov 19 01:48:04 2019", "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 191684203132223490, "name": "Shoko (\uc1fc\ucf54) (\u3057\u3087\u3046\u3053)\ud83e\udd94", "display_name": "Shoko (\uc1fc\ucf54) (\u3057\u3087\u3046\u3053)\ud83e\udd94", "discriminator": "9775", "afk_mentions": True, "xp": 10, "last_login": "Tue Nov 19 03:08:07 2019", "last_daily_reward": "Tue Nov 19 01:11:36 2019", "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 145208811584487425, "name": "kontas", "display_name": "kontas", "discriminator": "6555", "afk_mentions": True, "xp": 10, "last_login": "Tue Nov 19 03:08:16 2019", "last_daily_reward": "Tue Nov 19 01:10:03 2019", "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 203259041026277377, "name": "EternalCrow", "display_name": "EternalCrow", "discriminator": "7897", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 241586804267024387, "name": "Blixozzz", "display_name": "Blixozzz", "discriminator": "2690", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 290855281322360832, "name": "MXS", "display_name": "MXS", "discriminator": "7080", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 227869237975187457, "name": "ocelus", "display_name": "ocelus", "discriminator": "8229", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 340547964021768192, "name": "Linex", "display_name": "Linex", "discriminator": "5535", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 300699858657083392, "name": "BloodyCeryz", "display_name": "BloodyCeryz", "discriminator": "6280", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 307927059240321027, "name": "D3vilSt4r", "display_name": "D3vilSt4r", "discriminator": "1551", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 131450536066023425, "name": "Le quidam", "display_name": "Le quidam", "discriminator": "0338", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 180979596731088896, "name": "KevinKeldeo", "display_name": "KevinKeldeo", "discriminator": "8454", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 268800283096776715, "name": "\u25e4 \ud835\ude1a\ud835\ude36\ud835\ude2f\ud835\ude33\ud835\ude2a\ud835\ude34\ud835\ude26 \u25e2", "display_name": "\u25e4 \ud835\ude1a\ud835\ude36\ud835\ude2f\ud835\ude33\ud835\ude2a\ud835\ude34\ud835\ude26 \u25e2", "discriminator": "2019", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 524965955064037386, "name": "Morgiiine", "display_name": "Morgiiine", "discriminator": "9982", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 186144510537891841, "name": "Tapotix", "display_name": "Tapotix", "discriminator": "4078", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 231009101671432192, "name": "Yeianakel", "display_name": "Yeianakel", "discriminator": "8433", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 372487302254952448, "name": "Rowks", "display_name": "Rowks", "discriminator": "5693", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 392363689283420170, "name": "TkR95", "display_name": "TkR95", "discriminator": "0943", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 275310663856029696, "name": "TheBarbear", "display_name": "TheBarbear", "discriminator": "9234", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 351764702583324672, "name": "Toasty", "display_name": "Toasty", "discriminator": "4080", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 186484348143271938, "name": "yureka95", "display_name": "Frojam", "discriminator": "6655", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 173537115165032448, "name": "Himolia", "display_name": "Himolia", "discriminator": "1150", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 230056743697252352, "name": "Obergruppenf\u00fchrer Kaname", "display_name": "Obergruppenf\u00fchrer Kaname", "discriminator": "2391", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 509464650757439498, "name": "Shouxx", "display_name": "Shouxx", "discriminator": "5812", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 636093956480040960, "name": "InnKeeper", "display_name": "Roger le Tavernier", "discriminator": "4339", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 131446576181805056, "name": "\ud835\udcd1\ud835\udcdd\ud835\udcd9", "display_name": "\ud835\udcd1\ud835\udcdd\ud835\udcd9", "discriminator": "0455", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 337164038045696001, "name": "Kuramo", "display_name": "Kuramo", "discriminator": "7766", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 327955904236355599, "name": "Rakschtatt", "display_name": "El famoso Dudu", "discriminator": "1995", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 155149108183695360, "name": "Dyno", "display_name": "42", "discriminator": "3861", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 177894413488488448, "name": "Azzottess", "display_name": "Azzottess", "discriminator": "2932", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 255785578904158208, "name": "l KamZa", "display_name": "l KamZa", "discriminator": "9367", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 643056171565056011, "name": "testuser54", "display_name": "testuser54", "discriminator": "3447", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 165549278226415616, "name": "Akinos", "display_name": "Akinos", "discriminator": "9408", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 129011956488208385, "name": "Zhyma", "display_name": "Zhyma", "discriminator": "3378", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 363043143504887808, "name": "Rapidox", "display_name": "Rapidox", "discriminator": "9033", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 384383680375685123, "name": "Jahadar", "display_name": "Jahadar", "discriminator": "7353", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 225882575191801856, "name": "Destan", "display_name": "Destan", "discriminator": "8715", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 152400652067274752, "name": "mickiller", "display_name": "mickiller", "discriminator": "3524", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 324380295685996545, "name": "NERF JMS", "display_name": "NERF JMS", "discriminator": "5264", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 143773876223082496, "name": "spooky spec74 ! [Solid]", "display_name": "spooky spec74 ! [Solid]", "discriminator": "6065", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 160456060203827200, "name": "Seltz Azarate/Callipo11", "display_name": "Seltz Azarate/Callipo11", "discriminator": "5589", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 234395307759108106, "name": "Groovy", "display_name": "Groovy", "discriminator": "7254", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 398213929337094155, "name": "Gothorc", "display_name": "Gothorc", "discriminator": "6107", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 237510865929240576, "name": "casaaa", "display_name": "casaaa", "discriminator": "4109", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 270198738570444801, "name": "dabBot", "display_name": "dabBot", "discriminator": "0563", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 217415888242999308, "name": "GAB", "display_name": "GAB", "discriminator": "2011", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 272413559185473536, "name": "Sneep", "display_name": "Sneep", "discriminator": "7801", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 248882090710401025, "name": "Nikola\u00ef", "display_name": "Nikola\u00ef", "discriminator": "2734", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 170632685121830919, "name": "sensei14", "display_name": "sensei14", "discriminator": "6879", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}, {"id": 178890890000072705, "name": "Seiphyre", "display_name": "Seiphyre", "discriminator": "6566", "afk_mentions": True, "xp": 0, "last_login": None, "last_daily_reward": None, "muted": False, "muted_until": None, "deaf": False, "deaf_until": None, "warnings": []}]}
#db.update_server(361669162818600961, json.dumps(srv))
